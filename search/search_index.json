{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Infrastructure Knowledge Base","text":"<p>Local dev infrastructure: MCP servers, Cloudflare tunnels, launchd services, vault-mcp, and dotfiles.</p>","tags":["home","overview"]},{"location":"#whats-here","title":"What's Here","text":"<ul> <li>Architecture \u2014 System diagram, auth model, transport, tool reference</li> <li>Setup \u2014 Prerequisites, dotfiles, secrets, verification</li> <li>Services<ul> <li>Mac MCP \u2014 Node.js MCP server on localhost, exposed via Cloudflare Tunnel</li> <li>Vault MCP \u2014 Cloudflare Worker for workflow state, tasks, GitHub integration</li> <li>Cloudflare \u2014 DNS, Workers, Tunnels, D1, KV</li> </ul> </li> <li>Operations<ul> <li>Task Routing \u2014 Model discipline and orchestrator/executor split</li> <li>Git Conventions \u2014 Branching, commits, PRs, merge strategy</li> <li>Known Risks \u2014 SPOFs, mitigations, operational constraints</li> </ul> </li> <li>Decisions \u2014 Architecture Decision Records (ADR-0001 through ADR-0010)</li> </ul>","tags":["home","overview"]},{"location":"#quick-verification","title":"Quick Verification","text":"<pre><code>curl -sf http://127.0.0.1:3001/health          # Mac MCP server\ncurl -sf http://127.0.0.1:20241/ready           # Cloudflare Tunnel\nlaunchctl list | grep com.osman                 # All launchd services\n</code></pre>","tags":["home","overview"]},{"location":"architecture/","title":"Architecture (v2)","text":"","tags":["architecture","overview"]},{"location":"architecture/#overview","title":"Overview","text":"<p>This repo covers the full local dev infrastructure: MCP servers, Cloudflare services, launchd management, and dotfiles.</p>","tags":["architecture","overview"]},{"location":"architecture/#system-architecture","title":"System Architecture","text":"<pre><code>Claude.ai (Opus 4.6 orchestrator, 200K context)\n    \u2502\n    \u2502 MCP connections (Streamable HTTP, 3-layer auth)\n    \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  MCP Servers                                                     \u2502\n\u2502                                                                   \u2502\n\u2502  vault-mcp (CF Worker)    mac-mcp (CF Tunnel)    executor-mcp    \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502 McpAgent class    \u2502     \u2502 Node.js + Express\u2502   \u2502 Lightsail  \u2502 \u2502\n\u2502  \u2502 Streamable HTTP   \u2502     \u2502 Streamable HTTP  \u2502   \u2502 Direct HTTPS\u2502 \u2502\n\u2502  \u2502 D1 + KV + DO      \u2502     \u2502 HTTP/2 tunnel    \u2502   \u2502 or Tunnel  \u2502 \u2502\n\u2502  \u2502 10 consolidated   \u2502     \u2502 3-layer auth     \u2502   \u2502 Bearer auth\u2502 \u2502\n\u2502  \u2502 tools             \u2502     \u2502 SSE keepalive    \u2502   \u2502 Caddy + TLS\u2502 \u2502\n\u2502  \u2502 Bearer + CF Access\u2502     \u2502 11 tools         \u2502   \u2502            \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n    \u2502                                          \u2502\n    \u2502 API calls (classification)               \u2502 Task execution\n    \u25bc                                          \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 CF AI Gateway         \u2502    \u2502 Lightsail VM ($12/mo)            \u2502\n\u2502 (Phase 7)             \u2502    \u2502 \u251c\u2500\u2500 Claude Code (Max OAuth)      \u2502\n\u2502 \u2022 Cost analytics      \u2502    \u2502 \u251c\u2500\u2500 Codex CLI (ChatGPT auth)     \u2502\n\u2502 \u2022 Response caching    \u2502    \u2502 \u251c\u2500\u2500 Gemini CLI (Ultra acct)      \u2502\n\u2502 \u2022 Rate limiting       \u2502    \u2502 \u2514\u2500\u2500 Consensus diffing            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>","tags":["architecture","overview"]},{"location":"architecture/#auth-model-3-layer","title":"Auth Model (3-Layer)","text":"<ol> <li>Bearer token \u2014 app-level, per-endpoint, in Authorization header</li> <li>CF Access Service Token \u2014 edge enforcement, CF-Access-Client-Id/Secret headers</li> <li>Anthropic IP allowlist \u2014 WAF rule blocking non-Anthropic IPs on MCP hostnames</li> </ol> <p>Each layer independently revocable. See ADR-0006.</p>","tags":["architecture","overview"]},{"location":"architecture/#transport","title":"Transport","text":"<ul> <li>Primary: Streamable HTTP (current MCP spec)</li> <li>Deprecated: SSE (kept on vault-mcp /sse for backward compat)</li> <li>See ADR-0008.</li> </ul>","tags":["architecture","overview"]},{"location":"architecture/#tool-reference-10-consolidated-vault-mcp","title":"Tool Reference (10 consolidated, vault-mcp)","text":"Tool Actions/Params Purpose workflow init|spec|write|close Task lifecycle workflow_query summary|consensus|state|stats|chooser Read-only queries task add|update|done|retro|list Human task system (KV) execute instruction, executor, model, repo Proxy to VM executor github read|write|pr GitHub operations checkpoint load|save|decide State persistence search query Transcript search pricing \u2014 Model pricing from KV health \u2014 System status backup \u2014 KV/D1 backup export <p>See ADR-0007.</p>","tags":["architecture","overview"]},{"location":"architecture/#key-principles","title":"Key Principles","text":"<ol> <li>Model discipline: Opus orchestrates, Sonnet/Haiku implement (ADR-0005)</li> <li>Dotfiles as source of truth: ~/Developer/dotfiles/claude/ \u2192 ~/.claude/ via symlinks (ADR-0001)</li> <li>Cloudflare Tunnel for access: No open ports on Mac (ADR-0002)</li> <li>Keychain for secrets: macOS Keychain (account: osman), never plaintext</li> <li>Naming: \"workflow\" not \"pipeline\". vault-db is the D1 database.</li> </ol>","tags":["architecture","overview"]},{"location":"architecture/#service-map","title":"Service Map","text":"Service Endpoint Location Auth Status Mac MCP mac-mcp.deltaops.dev Local Mac 3-layer (Phase 1) \ud83d\udd34 No auth vault-mcp vault.deltaops.dev CF Worker Bearer \ud83d\udfe2 Healthy executor executor.deltaops.dev Lightsail VM Bearer (Phase 1) \ud83d\udfe1 SSH dead AI Gateway CF AI Gateway Cloudflare Token Phase 7","tags":["architecture","overview"]},{"location":"cloudflare/","title":"Cloudflare Services","text":"","tags":["cloudflare","infrastructure"]},{"location":"cloudflare/#domain","title":"Domain","text":"<p>deltaops.dev \u2014 managed via Cloudflare DNS.</p>","tags":["cloudflare","infrastructure"]},{"location":"cloudflare/#subdomains","title":"Subdomains","text":"Subdomain Target Type vault.deltaops.dev Cloudflare Worker (vault-mcp) Worker route mac-mcp.deltaops.dev Cloudflare Tunnel \u2192 localhost:3001 Tunnel executor.deltaops.dev Cloudflare Tunnel \u2192 Lightsail VM Tunnel (future)","tags":["cloudflare","infrastructure"]},{"location":"cloudflare/#workers","title":"Workers","text":"<ul> <li>vault-mcp: Workflow state, tasks, GitHub integration. Free tier.</li> </ul>","tags":["cloudflare","infrastructure"]},{"location":"cloudflare/#tunnels","title":"Tunnels","text":"<ul> <li>local-mcp tunnel: Mac \u2192 mac-mcp.deltaops.dev (4 ORD connections, http2Origin enabled)</li> <li>executor tunnel: Lightsail \u2192 executor.deltaops.dev (future, Phase 3)</li> </ul>","tags":["cloudflare","infrastructure"]},{"location":"cloudflare/#resources","title":"Resources","text":"<ul> <li>D1 database (vault-db): workflow state tables</li> <li>Workers KV: human task storage (TASKS_KV namespace)</li> <li>Durable Objects: McpAgent backing store</li> </ul>","tags":["cloudflare","infrastructure"]},{"location":"git-conventions/","title":"Git Conventions","text":"","tags":["git","conventions","workflow"]},{"location":"git-conventions/#identity","title":"Identity","text":"<pre><code>Osama Osman &lt;oosman@deltaops.dev&gt;\n</code></pre>","tags":["git","conventions","workflow"]},{"location":"git-conventions/#branch-naming","title":"Branch Naming","text":"Pattern Use <code>main</code> Production. Always deployable. <code>feat/&lt;name&gt;</code> New features <code>fix/&lt;name&gt;</code> Bug fixes <code>docs/&lt;name&gt;</code> Documentation changes <code>chore/&lt;name&gt;</code> Maintenance, tooling, CI","tags":["git","conventions","workflow"]},{"location":"git-conventions/#conventional-commits","title":"Conventional Commits","text":"<p>All commits follow Conventional Commits:</p> <pre><code>&lt;type&gt;: &lt;description&gt;\n\n[optional body]\n</code></pre>","tags":["git","conventions","workflow"]},{"location":"git-conventions/#types","title":"Types","text":"Type When <code>feat:</code> New feature or capability <code>fix:</code> Bug fix <code>docs:</code> Documentation only <code>chore:</code> Tooling, CI, dependencies <code>refactor:</code> Code change that neither fixes a bug nor adds a feature <code>test:</code> Adding or updating tests","tags":["git","conventions","workflow"]},{"location":"git-conventions/#examples","title":"Examples","text":"<pre><code>feat: vault-mcp v2 \u2014 McpAgent + 10 consolidated tools\nfix: tunnel reconnection on wake from sleep\ndocs: add ADR-0008 streamable HTTP\nchore: bump node to 25.x in CI\n</code></pre>","tags":["git","conventions","workflow"]},{"location":"git-conventions/#pull-requests","title":"Pull Requests","text":"<ul> <li>Title matches conventional commit format</li> <li>Description includes what changed and why</li> <li>Link related ADRs or issues</li> <li>Squash merge to main (clean history)</li> </ul>","tags":["git","conventions","workflow"]},{"location":"git-conventions/#merge-strategy","title":"Merge Strategy","text":"<ul> <li>Squash merge into main for feature branches</li> <li>Fast-forward for single-commit doc/chore changes</li> <li>Never force-push main</li> </ul>","tags":["git","conventions","workflow"]},{"location":"local-mcp/","title":"Local MCP Server","text":"<p>Node.js MCP server providing Claude.ai with direct Mac access.</p>","tags":["mcp","local","server"]},{"location":"local-mcp/#location","title":"Location","text":"<p>~/Developer/local-mcp/server.js (v3.0.0, ~837 lines)</p>","tags":["mcp","local","server"]},{"location":"local-mcp/#tools-11","title":"Tools (11)","text":"Tool Purpose run_command Execute shell commands read_file Read files from filesystem write_file Write files to filesystem list_dir List directory contents cc_dispatch Dispatch Claude Code agent (background) cc_status Check CC agent status cc_result Get completed CC agent output cc_kill Kill a running CC agent cc_send_input Send input to a running CC agent health Server health check self_test Run server self-diagnostics","tags":["mcp","local","server"]},{"location":"local-mcp/#services-3-launchd-plists","title":"Services (3 launchd plists)","text":"Service Plist Port MCP Server com.osman.local-mcp 3001 Cloudflare Tunnel com.osman.mcp-tunnel \u2014 Watchdog com.osman.mcp-watchdog \u2014","tags":["mcp","local","server"]},{"location":"local-mcp/#model-discipline-enforcement","title":"Model Discipline Enforcement","text":"<p>Server rejects cc_dispatch calls with <code>--model opus</code> or <code>--model claude-opus</code>. FORBIDDEN_MODELS array in server.js.</p>","tags":["mcp","local","server"]},{"location":"local-mcp/#monitoring","title":"Monitoring","text":"<pre><code># Health check\ncurl -sf http://127.0.0.1:3001/health | jq\n\n# Tunnel status  \ncurl -sf http://127.0.0.1:20241/ready\n\n# Logs\ntail -f ~/Developer/local-mcp/mcp.log\n\n# Restart\nlaunchctl kickstart -k gui/$(id -u)/com.osman.local-mcp\n</code></pre>","tags":["mcp","local","server"]},{"location":"local-mcp/#configuration","title":"Configuration","text":"<ul> <li>Token: macOS Keychain entry \"local-mcp-token\" (account: osman)</li> <li>Tunnel config: ~/Developer/local-mcp/cloudflared-config.yml</li> <li>Watchdog: ~/Developer/local-mcp/watchdog.sh (10s timeout)</li> </ul>","tags":["mcp","local","server"]},{"location":"risks/","title":"Known Risks","text":"","tags":["risks","operations","reliability"]},{"location":"risks/#mac-mcp-single-point-of-failure","title":"Mac MCP \u2014 Single Point of Failure","text":"<p>Risk: Mac MCP runs on a single local machine. Mac sleep, crashes, or network issues take it offline.</p> <p>Mitigations:</p> <ul> <li>Launchd auto-restart with watchdog (10s health check interval)</li> <li>VM SSH backup connection as fallback (executor on Lightsail can reach Mac)</li> <li>Cloudflare Tunnel reconnects automatically on wake</li> </ul> <p>Residual: If the Mac is powered off, no local MCP access until it comes back.</p>","tags":["risks","operations","reliability"]},{"location":"risks/#cloudflare-concentration","title":"Cloudflare Concentration","text":"<p>Risk: vault-mcp, tunnels, DNS, and D1 all depend on Cloudflare. A Cloudflare outage takes down everything.</p> <p>Mitigations:</p> <ul> <li>Cloudflare has 99.99% SLA on Workers</li> <li>Local MCP server still works on localhost:3001 without the tunnel</li> <li>D1 backup tool exports state for recovery</li> </ul> <p>Residual: Accepted. Cloudflare's reliability justifies the concentration for a solo project.</p>","tags":["risks","operations","reliability"]},{"location":"risks/#200k-context-limit","title":"200K Context Limit","text":"<p>Risk: Opus orchestrator has a 200K token hard limit. Complex sessions can exhaust context.</p> <p>Mitigations:</p> <ul> <li>~7,500 token overhead for system prompts, leaving ~192K for work</li> <li>Checkpoint system in vault-mcp for session continuity</li> <li>Decompose large tasks into smaller dispatched CC agents</li> </ul> <p>Residual: Very large tasks may still require session handoff.</p>","tags":["risks","operations","reliability"]},{"location":"risks/#credential-management","title":"Credential Management","text":"<p>Risk: Secrets stored in macOS Keychain are only accessible on the local Mac.</p> <p>Mitigations:</p> <ul> <li>All secrets accessed programmatically via <code>security find-generic-password</code></li> <li>Python helper at <code>~/Developer/dotfiles/claude/scripts/secrets.py</code></li> <li>Quarterly rotation schedule for Bearer tokens</li> </ul> <p>Residual: If Keychain is locked or Mac unavailable, secrets are inaccessible.</p>","tags":["risks","operations","reliability"]},{"location":"risks/#auth-secret-path-exposure","title":"Auth \u2014 Secret Path Exposure","text":"<p>Risk: Bearer tokens transmitted in HTTP headers could be intercepted.</p> <p>Mitigations:</p> <ul> <li>TLS everywhere (Cloudflare edge, tunnel encryption, Caddy on VM)</li> <li>3-layer auth: Bearer + CF Access Service Token + Anthropic IP allowlist</li> <li>Each layer independently revocable (see ADR-0006)</li> </ul> <p>Residual: Closed. Defense in depth makes single-layer compromise insufficient.</p>","tags":["risks","operations","reliability"]},{"location":"setup/","title":"Setup Guide","text":"","tags":["setup","onboarding"]},{"location":"setup/#prerequisites","title":"Prerequisites","text":"<ul> <li>macOS with Homebrew</li> <li>Node.js 25+ (<code>brew install node</code>)</li> <li>Claude Code (<code>npm i -g @anthropic-ai/claude-code</code>)</li> <li>gh CLI (<code>brew install gh</code>, authed via <code>gh auth login</code>)</li> <li>Git identity: <code>git config --global user.name \"Osama Osman\"</code> / <code>git config --global user.email \"oosman@deltaops.dev\"</code></li> </ul>","tags":["setup","onboarding"]},{"location":"setup/#dotfiles","title":"Dotfiles","text":"<p>All Claude config lives in ~/dotfiles/claude/ and is symlinked:</p> <pre><code>ls -la ~/.claude/  # Should show symlinks \u2192 ~/dotfiles/claude/\n</code></pre> <p>Key symlinked items: CLAUDE.md, commands/, contexts/, hooks/, scripts/, settings.json.</p>","tags":["setup","onboarding"]},{"location":"setup/#secrets","title":"Secrets","text":"<p>Managed via macOS Keychain (account: osman):</p> <pre><code># Check all secrets\npython3 ~/dotfiles/claude/scripts/secrets.py\n\n# Add a new secret\nsecurity add-generic-password -a \"osman\" -s \"KEY_NAME\" -w \"value\" -U\n\n# Regenerate exports\npython3 ~/dotfiles/claude/scripts/secrets.py  # writes ~/.claude/secrets-env.sh\n</code></pre>","tags":["setup","onboarding"]},{"location":"setup/#local-mcp-server","title":"Local MCP Server","text":"<p>See docs/local-mcp.md for full details.</p> <pre><code># Verify all three services\nlaunchctl list | grep com.osman\ncurl -sf http://127.0.0.1:3001/health  # server\ncurl -sf http://127.0.0.1:20241/ready  # tunnel\n</code></pre>","tags":["setup","onboarding"]},{"location":"setup/#working-directories","title":"Working Directories","text":"Purpose Path Infrastructure ~/Developer/infrastructure/ Local MCP ~/Developer/local-mcp/ Projects ~/Developer/projects/ Archives ~/Developer/archive/ Dotfiles ~/dotfiles/","tags":["setup","onboarding"]},{"location":"task-routing/","title":"Task Routing","text":"","tags":["workflow","model-discipline","orchestration"]},{"location":"task-routing/#the-split-orchestrator-vs-executor","title":"The Split: Orchestrator vs Executor","text":"<p>The infrastructure enforces a strict separation between planning and execution.</p>","tags":["workflow","model-discipline","orchestration"]},{"location":"task-routing/#orchestrator-claudeai-opus","title":"Orchestrator (Claude.ai \u2014 Opus)","text":"<ul> <li>Plans, decomposes tasks, makes architectural decisions</li> <li>Runs in Claude.ai conversations with full 200K context</li> <li>Dispatches work to executors via <code>cc_dispatch</code> through Mac MCP</li> <li>Never executes code directly</li> </ul>","tags":["workflow","model-discipline","orchestration"]},{"location":"task-routing/#executors-cc-agents-sonnethaiku","title":"Executors (CC Agents \u2014 Sonnet/Haiku)","text":"<ul> <li>Receive specific, scoped instructions from the orchestrator</li> <li>Run as Claude Code agents dispatched by Mac MCP</li> <li>Sonnet (default) for implementation, Haiku for simple/fast tasks</li> <li>Never make architectural decisions</li> </ul>","tags":["workflow","model-discipline","orchestration"]},{"location":"task-routing/#model-discipline","title":"Model Discipline","text":"<p>This is non-negotiable. See ADR-0005.</p> Role Model Cost (in/out per MTok) Orchestrator Opus $15 / $75 Executor (default) Sonnet $3 / $15 Executor (simple) Haiku $0.80 / $4","tags":["workflow","model-discipline","orchestration"]},{"location":"task-routing/#enforcement","title":"Enforcement","text":"<p>Mac MCP server rejects <code>cc_dispatch</code> calls with <code>--model opus</code> or <code>--model claude-opus</code>. The <code>FORBIDDEN_MODELS</code> array in <code>server.js</code> blocks these at the server level before dispatch.</p>","tags":["workflow","model-discipline","orchestration"]},{"location":"task-routing/#dispatch-flow","title":"Dispatch Flow","text":"<pre><code>Claude.ai (Opus) \u2192 cc_dispatch(name, prompt, cwd) \u2192 Mac MCP \u2192 Claude Code agent (Sonnet)\n                                                         \u2193\n                                                   cc_status(name) \u2192 check progress\n                                                   cc_result(name) \u2192 get output\n                                                   cc_kill(name)   \u2192 abort if stuck\n</code></pre>","tags":["workflow","model-discipline","orchestration"]},{"location":"task-routing/#when-to-use-each-model","title":"When to Use Each Model","text":"Task Model Why Multi-file refactor Sonnet Needs code understanding Write a single function Haiku Simple, scoped Run tests and report Haiku Mechanical Debug a complex issue Sonnet Needs reasoning Architecture decision Opus (orchestrator) Planning only","tags":["workflow","model-discipline","orchestration"]},{"location":"vault-mcp/","title":"vault-mcp","text":"<p>Cloudflare Worker providing workflow state management, task tracking, and GitHub integration via MCP protocol.</p>","tags":["mcp","cloudflare","vault"]},{"location":"vault-mcp/#endpoint","title":"Endpoint","text":"<p>https://vault.deltaops.dev/mcp</p>","tags":["mcp","cloudflare","vault"]},{"location":"vault-mcp/#capabilities","title":"Capabilities","text":"<ul> <li>Workflow state: task lifecycle, stage tracking, consensus, circuit breakers (D1 database)</li> <li>Human tasks: CRUD via Workers KV, binary status (open/done)</li> <li>GitHub: read/write files, create PRs</li> <li>Checkpoints: state persistence for session continuity</li> </ul>","tags":["mcp","cloudflare","vault"]},{"location":"vault-mcp/#auth","title":"Auth","text":"<p>Bearer token in MCP config. Rotate quarterly: <code>npx wrangler secret put VAULT_AUTH_TOKEN</code></p>","tags":["mcp","cloudflare","vault"]},{"location":"vault-mcp/#infrastructure","title":"Infrastructure","text":"<ul> <li>Runtime: Cloudflare Workers (free tier)</li> <li>Database: D1 (SQLite)</li> <li>KV: Workers KV (task storage)</li> <li>Durable Objects: McpAgent class</li> </ul>","tags":["mcp","cloudflare","vault"]},{"location":"vault-mcp/#status","title":"Status","text":"<p>Deployed and operational. Workflow state routes built (6 files, 1,617 lines). D1 migrations pending.</p>","tags":["mcp","cloudflare","vault"]},{"location":"decisions/0001-foundational-constraints/","title":"ADR-0001: Foundational Constraints","text":"","tags":["architecture","constraints","foundational"]},{"location":"decisions/0001-foundational-constraints/#context","title":"Context","text":"<p>Establishing non-negotiable principles for how all projects operate under AI-driven development.</p>","tags":["architecture","constraints","foundational"]},{"location":"decisions/0001-foundational-constraints/#decision","title":"Decision","text":"<p>Six constraints govern all work: 1. Code must not be written by humans 2. Code must not be reviewed by humans 3. Value of context engineering is in distillation not plumbing 4. Never delegate decision of what context matters to tools that manage it 5. Humans own intent and curation, machines own implementation and validation 6. Dotfiles symlink structure \u2014 all config lives in ~/dotfiles/claude/ and is symlinked from ~/.claude/</p>","tags":["architecture","constraints","foundational"]},{"location":"decisions/0001-foundational-constraints/#consequences","title":"Consequences","text":"<ul> <li>\u2705 Clear division of responsibility between human and AI</li> <li>\u2705 All config is version-controlled via dotfiles</li> <li>\u26a0\ufe0f Requires discipline to never shortcut and write code directly</li> </ul>","tags":["architecture","constraints","foundational"]},{"location":"decisions/0002-cloudflare-tunnel/","title":"ADR-0002: Cloudflare Tunnel for MCP Access","text":"","tags":["infrastructure","networking","cloudflare"]},{"location":"decisions/0002-cloudflare-tunnel/#context","title":"Context","text":"<p>Need secure remote access to local Mac MCP server from Claude.ai without exposing ports.</p>","tags":["infrastructure","networking","cloudflare"]},{"location":"decisions/0002-cloudflare-tunnel/#decision","title":"Decision","text":"<p>Use Cloudflare Tunnel (cloudflared) to route mac-mcp.deltaops.dev \u2192 localhost:3001. No Tailscale, no port forwarding.</p>","tags":["infrastructure","networking","cloudflare"]},{"location":"decisions/0002-cloudflare-tunnel/#consequences","title":"Consequences","text":"<ul> <li>\u2705 Native to Cloudflare stack (DNS, Workers, Tunnel all in one)</li> <li>\u2705 Zero open ports on local machine</li> <li>\u26a0\ufe0f Depends on Cloudflare availability</li> <li>\u26a0\ufe0f Tunnel reconnections can cause brief MCP timeouts</li> </ul>","tags":["infrastructure","networking","cloudflare"]},{"location":"decisions/0003-lightsail-dual-stack/","title":"ADR-0003: Lightsail Dual-Stack Small","text":"","tags":["infrastructure","vm","aws"]},{"location":"decisions/0003-lightsail-dual-stack/#context","title":"Context","text":"<p>Need a persistent Linux VM for running CLI executors (Claude Code, Codex, Gemini CLI) with shared repos.</p>","tags":["infrastructure","vm","aws"]},{"location":"decisions/0003-lightsail-dual-stack/#decision","title":"Decision","text":"<p>AWS Lightsail dual-stack Small ($12/mo, 3 months free). 2GB RAM, 2 vCPU, 60GB SSD, 3TB transfer. Decouples VM billing from API/GCP credits.</p>","tags":["infrastructure","vm","aws"]},{"location":"decisions/0003-lightsail-dual-stack/#consequences","title":"Consequences","text":"<ul> <li>\u2705 Predictable flat pricing, generous bandwidth</li> <li>\u2705 IPv4+IPv6 \u2014 GitHub/npm work without NAT64 hacks</li> <li>\u26a0\ufe0f Not co-located with GCP (slightly higher latency to Vertex AI)</li> <li>\u26a0\ufe0f $2/mo premium over IPv6-only</li> </ul>","tags":["infrastructure","vm","aws"]},{"location":"decisions/0004-mac-mcp-architecture/","title":"ADR-0004: Mac MCP Architecture","text":"","tags":["infrastructure","mcp","local"]},{"location":"decisions/0004-mac-mcp-architecture/#context","title":"Context","text":"<p>Need Claude.ai to execute commands on local Mac \u2014 file ops, CC dispatch, shell commands \u2014 via MCP protocol.</p>","tags":["infrastructure","mcp","local"]},{"location":"decisions/0004-mac-mcp-architecture/#decision","title":"Decision","text":"<p>Custom Node.js MCP server (server.js, ~837 lines) on localhost:3001 with Cloudflare Tunnel. 11 tools including cc_dispatch/status/result/kill. Launchd-managed with watchdog for auto-recovery. Server enforces model discipline (rejects opus dispatch).</p>","tags":["infrastructure","mcp","local"]},{"location":"decisions/0004-mac-mcp-architecture/#consequences","title":"Consequences","text":"<ul> <li>\u2705 Claude.ai has direct local machine access</li> <li>\u2705 CC agents dispatched from conversations without SSH</li> <li>\u2705 Watchdog ensures zero-downtime (previously crashed 3x/day, now 0)</li> <li>\u26a0\ufe0f Single point of failure \u2014 if Mac sleeps, MCP is down</li> <li>\u26a0\ufe0f Tunnel latency adds ~200-500ms per tool call</li> </ul>","tags":["infrastructure","mcp","local"]},{"location":"decisions/0005-model-discipline/","title":"ADR-0005: Model Discipline Rule","text":"","tags":["architecture","constraints","models"]},{"location":"decisions/0005-model-discipline/#context","title":"Context","text":"<p>Opus is expensive ($5/$25 per MTok) and should be reserved for planning/orchestration. Dispatching Opus for implementation work wastes the cost advantage of the model ladder.</p>","tags":["architecture","constraints","models"]},{"location":"decisions/0005-model-discipline/#decision","title":"Decision","text":"<p>Opus plans and orchestrates ONLY (Claude.ai conversations). All CC agents dispatched via cc_dispatch MUST use sonnet (default) or haiku. Never opus. Enforced server-side: Mac MCP server has FORBIDDEN_MODELS array that rejects opus dispatch requests.</p>","tags":["architecture","constraints","models"]},{"location":"decisions/0005-model-discipline/#consequences","title":"Consequences","text":"<ul> <li>\u2705 Cost discipline \u2014 implementation work uses $3/$15 Sonnet, not $5/$25 Opus</li> <li>\u2705 Server-side enforcement prevents accidental misuse</li> <li>\u26a0\ufe0f If a task genuinely needs Opus-level reasoning, must be done in Claude.ai conversation, not delegated</li> </ul>","tags":["architecture","constraints","models"]},{"location":"decisions/0006-three-layer-auth/","title":"ADR-0006: 3-Layer Authentication","text":"","tags":["security","authentication","cloudflare"]},{"location":"decisions/0006-three-layer-auth/#context","title":"Context","text":"<p>mac-mcp had zero authentication, exposing remote code execution. All MCP endpoints need defense in depth to prevent unauthorized access.</p>","tags":["security","authentication","cloudflare"]},{"location":"decisions/0006-three-layer-auth/#decision","title":"Decision","text":"<p>3-layer auth on all endpoints: Bearer token (app-level) + Cloudflare Access Service Token (edge) + Anthropic IP allowlist (WAF). Each layer is independently configured and revocable.</p>","tags":["security","authentication","cloudflare"]},{"location":"decisions/0006-three-layer-auth/#consequences","title":"Consequences","text":"<ul> <li>\u2705 Near-zero attack surface \u2014 attacker must bypass all three layers</li> <li>\u2705 Each layer independently revocable without affecting others</li> <li>\u26a0\ufe0f More complex initial setup and credential rotation</li> </ul>","tags":["security","authentication","cloudflare"]},{"location":"decisions/0007-tool-consolidation/","title":"ADR-0007: Tool Consolidation (20 \u2192 10)","text":"","tags":["architecture","vault-mcp","tools"]},{"location":"decisions/0007-tool-consolidation/#context","title":"Context","text":"<p>vault-mcp had 20+ tools. Schema overhead was ~5,000 tokens per session start, consuming context budget on every conversation.</p>","tags":["architecture","vault-mcp","tools"]},{"location":"decisions/0007-tool-consolidation/#decision","title":"Decision","text":"<p>Consolidate to 10 tools using action/query parameters for sub-operations: workflow(action: init|spec|write|close), workflow_query(query: summary|consensus|state|stats|chooser), task, execute, github, checkpoint, search, pricing, health, backup.</p>","tags":["architecture","vault-mcp","tools"]},{"location":"decisions/0007-tool-consolidation/#consequences","title":"Consequences","text":"<ul> <li>\u2705 ~3,000 tokens saved per session start</li> <li>\u2705 Cleaner mental model for tool selection</li> <li>\u26a0\ufe0f Slightly more complex tool implementations with action routing</li> </ul>","tags":["architecture","vault-mcp","tools"]},{"location":"decisions/0008-streamable-http/","title":"ADR-0008: Streamable HTTP over SSE","text":"","tags":["architecture","transport","cloudflare"]},{"location":"decisions/0008-streamable-http/#context","title":"Context","text":"<p>SSE is deprecated in the MCP spec. mac-mcp already uses Streamable HTTP. SSE has a 100-second timeout cliff on Cloudflare that causes dropped connections.</p>","tags":["architecture","transport","cloudflare"]},{"location":"decisions/0008-streamable-http/#decision","title":"Decision","text":"<p>Streamable HTTP as primary transport for all MCP endpoints. SSE kept for backward compatibility on vault-mcp /sse endpoint only.</p>","tags":["architecture","transport","cloudflare"]},{"location":"decisions/0008-streamable-http/#consequences","title":"Consequences","text":"<ul> <li>\u2705 No 100-second timeout issue for request-response tools</li> <li>\u2705 Aligns with MCP spec direction</li> <li>\u26a0\ufe0f Long-running tasks still need keepalives to avoid idle timeouts</li> </ul>","tags":["architecture","transport","cloudflare"]},{"location":"decisions/0009-portal-spike/","title":"ADR-0009: Portal Spike Before Commitment","text":"","tags":["architecture","cloudflare","evaluation"]},{"location":"decisions/0009-portal-spike/#context","title":"Context","text":"<p>Cloudflare MCP Server Portal could unify 3 endpoints into 1. Untested with custom Node.js servers behind tunnels \u2014 risk of committing to an architecture that doesn't work.</p>","tags":["architecture","cloudflare","evaluation"]},{"location":"decisions/0009-portal-spike/#decision","title":"Decision","text":"<p>2-hour spike in Phase 6 with test subdomain (mcp-test.deltaops.dev). Adopt only if latency &lt; 200ms overhead and both servers work. 3-endpoint model is the baseline fallback.</p>","tags":["architecture","cloudflare","evaluation"]},{"location":"decisions/0009-portal-spike/#consequences","title":"Consequences","text":"<ul> <li>\u2705 No architecture dependency on Portal \u2014 clear go/no-go criteria</li> <li>\u2705 Low-cost evaluation with defined success metrics</li> <li>\u26a0\ufe0f Fallback is current working 3-endpoint model if spike fails</li> </ul>","tags":["architecture","cloudflare","evaluation"]},{"location":"decisions/0010-ai-gateway-deferred/","title":"ADR-0010: AI Gateway Deferred Until Traffic","text":"","tags":["architecture","cloudflare","ai-gateway"]},{"location":"decisions/0010-ai-gateway-deferred/#context","title":"Context","text":"<p>No programmatic API traffic exists until orchestration wiring is complete. The only calls will be classification passes (~$0.002/task) \u2014 not enough volume to justify gateway overhead now.</p>","tags":["architecture","cloudflare","ai-gateway"]},{"location":"decisions/0010-ai-gateway-deferred/#decision","title":"Decision","text":"<p>Create AI Gateway in Phase 7 after orchestration works. Route classification calls only. Expand when traffic grows.</p>","tags":["architecture","cloudflare","ai-gateway"]},{"location":"decisions/0010-ai-gateway-deferred/#consequences","title":"Consequences","text":"<ul> <li>\u2705 No premature optimization \u2014 gateway value scales with volume</li> <li>\u2705 Simpler initial architecture with fewer moving parts</li> <li>\u26a0\ufe0f Manual cost tracking until gateway is in place</li> </ul>","tags":["architecture","cloudflare","ai-gateway"]},{"location":"decisions/_adr-template/","title":"ADR-NNNN: Title","text":"","tags":[]},{"location":"decisions/_adr-template/#context","title":"Context","text":"<p>Why this decision was needed. 2-3 sentences max.</p>","tags":[]},{"location":"decisions/_adr-template/#decision","title":"Decision","text":"<p>What we decided. 1-2 sentences.</p>","tags":[]},{"location":"decisions/_adr-template/#consequences","title":"Consequences","text":"<ul> <li>\u2705 Good thing</li> <li>\u26a0\ufe0f Trade-off or risk</li> </ul>","tags":[]}]}